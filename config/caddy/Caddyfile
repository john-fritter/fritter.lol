{
    email jefritter@gmail.com
}

# Root Site
fritter.lol {
  encode zstd gzip

  # --- 1) API FIRST: /api/media/* -> media-proxy ---
  @media_api path /api/media/*
  handle @media_api {
    header {
      Cache-Control max-age=15, public
    }
    reverse_proxy media-proxy:8080
  }

  # --- 2) Redirects for old /server paths ---
  @old_server path /server /server/
  redir @old_server https://server.fritter.lol/ 308

  @old_server_html path /server.html
  redir @old_server_html https://server.fritter.lol/ 308

  # If anything still hits the old API path, forward it to the new host
  @old_api path /server/api/*
  handle @old_api {
    uri replace /server/api /api
    redir https://server.fritter.lol{uri} 308
  }

  # --- 3) Static site (path INSIDE the Caddy container) ---
  root * /srv/site
  handle {
    try_files {path} /index.html
    file_server
  }

  # --- 4) Global headers ---
  header {
    X-Frame-Options "DENY"
    Referrer-Policy "no-referrer"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
  }

  # --- 5) Logging ---
  log {
    output file /var/log/caddy/access.log
    format json
  }

  # --- 6) Custom 404 (set root again inside error handler) ---
  handle_errors {
    @is404 expression {http.error.status_code} == 404
    root * /srv/site
    rewrite @is404 /404.html
    file_server
  }
}


# Dashy
server.fritter.lol {
  encode zstd gzip

  basic_auth * {
    admin $2a$14$umId4twQ0JvwfmKh3mp/leq7B8kEBwRP8XVRRyJe2BUD0McqxPhzC
  }

  reverse_proxy dashy:8080

  log {
    output file /var/log/caddy/access.log
    format json
  }
}


# Overseerr
overseerr.fritter.lol {
  reverse_proxy overseerr:5055
  log {
    output file /var/log/caddy/access.log
    format json
  }
}

# Sonarr
sonarr.fritter.lol {
    reverse_proxy sonarr:8989

    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# Radarr
radarr.fritter.lol {
    reverse_proxy radarr:7878

    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# Prowlarr
prowlarr.fritter.lol {
    reverse_proxy prowlarr:9696

    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# Cloud Commander
files.fritter.lol {
    reverse_proxy cloudcmd:8000

    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# qBittorrent
qb.fritter.lol {
    reverse_proxy qbittorrent:8080

    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# Plex
plex.fritter.lol {
    reverse_proxy plex:32400

    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# Jellyfin
jellyfin.fritter.lol {
  reverse_proxy jellyfin:8096
}

# Jellyseerr
jellyseerr.fritter.lol {
  reverse_proxy jellyseerr:5055
}

# Bazarr
bazarr.fritter.lol {
  reverse_proxy bazarr:6767

  log {
    output file /var/log/caddy/access.log
    format json
  }
}

grafana.fritter.lol {
  reverse_proxy grafana:3000
  header {
    X-Frame-Options "ALLOWALL"
    Content-Security-Policy "frame-ancestors https://server.fritter.lol https://*.fritter.lol"
  }
  log {
    output file /var/log/caddy/access.log
    format json
  }
}

prometheus.fritter.lol {
  basic_auth * {
    admin $2a$14$umId4twQ0JvwfmKh3mp/leq7B8kEBwRP8XVRRyJe2BUD0McqxPhzC
  }
  reverse_proxy prometheus:9090
  log {
    output file /var/log/caddy/access.log
    format json
  }
}

tautulli.fritter.lol {
    reverse_proxy tautulli:8181
}