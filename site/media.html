<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Media · fritter.lol</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .muted { opacity:.75; font-size:.9rem }
    .row { display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .btn-row { display:flex; gap:10px; flex-wrap:wrap }
    .grid-2 { display:grid; gap:16px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    .poster-carousel { position:relative; }
    .poster-grid { display:flex; gap:10px; overflow-x:hidden; scroll-behavior:smooth; width:470px; }
    .poster-grid .tile { flex:0 0 110px; width:110px; }
    .tile { position:relative; display:flex; flex-direction:column; }
    .tile img { width:110px; height:165px; aspect-ratio:2/3; object-fit:cover; border-radius:10px }
    .tile .t { font-weight:600; font-size:.95rem; }
    .tile .s { font-size:.85rem; opacity:.8 }
    .tile .overlay { 
      position:absolute; 
      top:0; left:0; right:0; bottom:0; 
      background:linear-gradient(transparent 60%, rgba(0,0,0,0.8)); 
      border-radius:10px; 
      display:flex; 
      flex-direction:column; 
      justify-content:flex-end; 
      padding:8px; 
      opacity:0; 
      transition:opacity 0.2s ease;
      pointer-events:none;
    }
    .tile:hover .overlay { opacity:1; }
    .tile .overlay .t { color:white; font-weight:600; font-size:.9rem; margin:0; }
    .tile .overlay .s { color:rgba(255,255,255,0.9); font-size:.8rem; margin:2px 0 0; }
    .carousel-nav { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.7); border:none; color:white; width:32px; height:32px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:14px; z-index:10; transition:background-color 0.2s; }
    .carousel-nav:hover { background:rgba(0,0,0,0.9); }
    .carousel-nav:disabled { opacity:0.3; cursor:not-allowed; }
    .carousel-nav.prev { left:8px; }
    .carousel-nav.next { right:8px; }
    .chart { width:100%; height:120px; }
    .pill { display:inline-block; padding:.2rem .5rem; border-radius:999px; border:1px solid rgba(255,255,255,.15); font-size:.8rem }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1 style="margin:0 0 8px;"><a href="/" class="site-title">fritter.lol</a></h1>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row">
        <h2 style="margin:0">Media Hub</h2>
        <div class="btn-row">
          <a class="btn" href="https://jellyfin.fritter.lol">Open Jellyfin</a>
          <a class="btn" href="https://jellyseerr.fritter.lol">Open Jellyseerr</a>
        </div>
      </div>
      <p class="muted">A public peek at what’s been watched lately and weekly activity. No private details shown.</p>
    </section>

    <section class="grid-2">
      <div class="card">
        <div class="row"><h3 style="margin:0">Recently Watched</h3></div>
        <div class="poster-carousel">
          <button class="carousel-nav prev" onclick="scrollCarousel('watched', -1)">‹</button>
          <div id="watched" class="poster-grid"></div>
          <button class="carousel-nav next" onclick="scrollCarousel('watched', 1)">›</button>
        </div>
      </div>

      <div class="card">
        <div class="row"><h3 style="margin:0">Recently Added</h3></div>
        <div class="poster-carousel">
          <button class="carousel-nav prev" onclick="scrollCarousel('added', -1)">‹</button>
          <div id="added" class="poster-grid"></div>
          <button class="carousel-nav next" onclick="scrollCarousel('added', 1)">›</button>
        </div>
      </div>
    </section>

    <section class="grid-2">
      <div class="card">
        <div class="row"><h3 style="margin:0">Weekly Activity</h3><span class="muted">Last 7 days</span></div>
        <div id="weeklyGrid" style="margin-top:12px;"></div>
      </div>

      <div class="card">
        <div class="row"><h3 style="margin:0">Monthly Activity</h3><span class="muted">Last 30 days</span></div>
        <div id="monthlyGrid" style="margin-top:12px;"></div>
      </div>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    const apibase = '/api/media';
    const placeholder = '/placeholder-poster.jpg';

    async function get(p){
      const r = await fetch(`${apibase}${p}`, { headers: { 'Accept':'application/json' }});
      if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    function tile(item){
      const title = item.grandparent_title ? `${item.grandparent_title} — ${item.title}` : item.title;
      const when = item.watched_at ? 
        new Date(item.watched_at).toLocaleDateString() : 
        item.added_at ? new Date(item.added_at).toLocaleDateString() : '';
      const img = item.poster ? item.poster : placeholder;
      return `<div class="tile">
        <img src="${img}" alt="${title}">
        <div class="overlay">
          <div class="t">${title || 'Unknown'}</div>
          <div class="s">${when}</div>
        </div>
      </div>`;
    }
    
    // Create GitHub-style activity grid (7x8 for weekly)
    function drawWeeklyGrid(data) {
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const timeBlocks = ['00-03', '03-06', '06-09', '09-12', '12-15', '15-18', '18-21', '21-24'];
      const maxValue = Math.max(1, ...Object.values(data));
      
      let html = '<div class="grid-container" style="display:grid; grid-template-columns: auto repeat(8, 1fr); gap:3px;">';
      
      // Add time block headers
      html += '<div></div>'; // Empty corner cell
      for (let i = 0; i < timeBlocks.length; i++) {
        html += `<div style="text-align:center; font-size:0.7rem;">${timeBlocks[i]}</div>`;
      }
      
      // Add days and cells
      for (let day = 0; day < days.length; day++) {
        html += `<div style="font-size:0.8rem; align-self:center;">${days[day]}</div>`;
        
        for (let block = 0; block < timeBlocks.length; block++) {
          const key = `${days[day]}_${timeBlocks[block]}`;
          const value = data[key] || 0;
          const intensity = value > 0 ? Math.max(0.2, Math.min(1, value / maxValue)) : 0;
          
          html += `<div title="${days[day]} ${timeBlocks[block]}: ${value} plays" 
                      style="background-color:rgba(59, 130, 246, ${intensity}); 
                             border-radius:2px; aspect-ratio:1; 
                             min-width:15px; min-height:15px;"></div>`;
        }
      }
      
      html += '</div>';
      return html;
    }
    
    // Create GitHub-style monthly grid
    function drawMonthlyGrid(data) {
      const maxValue = Math.max(1, ...Object.values(data));
      const weeks = 5; // 4-5 weeks in a month
      const days = 7;
      
      let html = '<div class="grid-container" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:3px;">';
      
      // Create grid cells for each day
      for (let week = 0; week < weeks; week++) {
        for (let day = 0; day < days; day++) {
          const index = week * days + day;
          const dayNum = 30 - index; // Count backward from today
          
          if (dayNum < 1) continue; // Skip days that would be before the month
          
          const key = `day_${dayNum}`;
          const value = data[key] || 0;
          const intensity = value > 0 ? Math.max(0.2, Math.min(1, value / maxValue)) : 0;
          const date = new Date();
          date.setDate(date.getDate() - (30 - dayNum));
          const dateStr = date.toLocaleDateString();
          
          html += `<div title="${dateStr}: ${value} plays" 
                      style="background-color:rgba(59, 130, 246, ${intensity}); 
                             border-radius:2px; aspect-ratio:1;
                             min-width:15px; min-height:15px;"></div>`;
        }
      }
      
      html += '</div>';
      return html;
    }

    function scrollCarousel(containerId, direction) {
      const container = $(`#${containerId}`);
      const tileWidth = 110; // Fixed tile width
      const gap = 10; // Gap between tiles
      const scrollAmount = (tileWidth + gap) * 4; // Scroll by exactly 4 items
      container.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
      });
      
      // Update button states after scroll
      setTimeout(() => updateCarouselButtons(containerId), 300);
    }

    function updateCarouselButtons(containerId) {
      const container = $(`#${containerId}`);
      const carousel = container.parentElement;
      const prevBtn = carousel.querySelector('.carousel-nav.prev');
      const nextBtn = carousel.querySelector('.carousel-nav.next');
      
      // Check if we can scroll left or right
      const canScrollLeft = container.scrollLeft > 0;
      const canScrollRight = container.scrollLeft < (container.scrollWidth - container.offsetWidth);
      
      prevBtn.disabled = !canScrollLeft;
      nextBtn.disabled = !canScrollRight;
    }

    async function boot(){
      try{
        const [watched, added, weeklyActivity, monthlyActivity] = await Promise.all([
          get('/recently-watched?limit=10'),
          get('/recently-added?limit=10'),
          get('/activity/weekly'),
          get('/activity/monthly'),
        ]);

        // Recently watched tiles
        const watchedItems = watched.items || [];
        $('#watched').innerHTML = watchedItems.length
          ? watchedItems.map(tile).join('')
          : `<div class="muted">No watch history yet. Start something in Jellyfin!</div>`;

        // Recently added tiles
        const addedItems = added.items || [];
        $('#added').innerHTML = addedItems.length
          ? addedItems.map(tile).join('')
          : `<div class="muted">No recently added content.</div>`;

        // Initialize carousel button states
        setTimeout(() => {
          updateCarouselButtons('watched');
          updateCarouselButtons('added');
        }, 100);

        // Weekly activity grid (7x8)
        const weeklyData = weeklyActivity.data || {};
        if (weeklyActivity.warning) {
          $('#weeklyGrid').innerHTML = `<div class="muted">${weeklyActivity.warning}</div>`;
        } else {
          $('#weeklyGrid').innerHTML = drawWeeklyGrid(weeklyData);
        }
        
        // Monthly activity grid
        const monthlyData = monthlyActivity.data || {};
        if (monthlyActivity.warning) {
          $('#monthlyGrid').innerHTML = `<div class="muted">${monthlyActivity.warning}</div>`;
        } else {
          $('#monthlyGrid').innerHTML = drawMonthlyGrid(monthlyData);
        }

      } catch(e){
        console.error(e);
        $('#watched').innerHTML = `<div class="muted">Failed to load.</div>`;
        $('#added').innerHTML = `<div class="muted">Failed to load.</div>`;
        $('#weeklyGrid').innerHTML = `<div class="muted">Failed to load activity data.</div>`;
        $('#monthlyGrid').innerHTML = `<div class="muted">Failed to load activity data.</div>`;
      }
    }
    boot();
  </script>
</body>
</html>
